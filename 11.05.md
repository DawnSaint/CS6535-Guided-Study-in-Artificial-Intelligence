## Guided Study 11.20 进度汇报



##### I、debug 机制

此前的baseline只生成了一个最终的分数，没办法看到每个task具体的输入、输出，我们在agent的关键步骤加入了观察点，在最终生成结果的时候将task的输入、输出也持久化下来，包括：

- 每一条数据的 user 信息
- item信息
- item 历史评论
- user历史评论
- 每一个 agent 节点模型生成的结果
- 这一条task单独的评分

为后续定位和分析 badcase 提供了数据支持。

**github提交**：https://github.com/DawnSaint/CS6535-Guided-Study-in-Artificial-Intelligence/commit/1b6c9fddcfb6ad031e4656f22280f8b0f15d6f5c



##### II、请求失败问题解决

引入debug机制后我们发现 agent 得分浮动在 0.6~0.8 的原因是有一些请求触发了无问芯穹 api 的节流机制，没有返回结果，走了代码中try catch的部分，使用默认评分3.0和空字符串来计算评分。对此我们升级了服务级别，将RPM = 12 增长到 1200，改进后生成的结果能够稳定在 8.5 分以上。



##### III、针对 badcase 修改 prompt

通过 debug 机制收集到的 task 细粒度数据，我们对低分样本（badcase）进行了人工回溯和总结分析，发现系统过于依赖 agent 几步生成的语言概述，如果生成的概述侧重点异常会导致错误积累效应，致使最终的结果误差被放大。针对这些问题我们结构化重构了 prompt，并加入了 场景化指导语、情绪约束模板，提升模型生成的稳定性。

改进生成用户描述函数（generate_user_description），由粗暴的全量数据转换，改为精准提取关键指标（如预计算好友数量而非传输庞大的ID列表），不仅大幅降低了 Token 消耗，还通过过滤了无关或敏感数据。其次，将提示词从笼统的描述优化为清晰的结构化指令（Numbered List），明确界定了生成维度（活跃度、影响力、社交），从而引导模型生成重点更突出、风格更流畅的人物画像，避免了对原始数据的机械复述。

```python
    def generate_user_description(self, user_info, source) -> str:
        """
        生成用户描述并返回响应。

        :param user_info: 包含用户信息的字典
        :param source: 数据源（例如 'yelp'）
        """

        stats = {
            "review_count": user_info.get("review_count"),
            "useful": user_info.get("useful"),
            "funny": user_info.get("funny"),
            "cool": user_info.get("cool"),
            "elite": user_info.get("elite"),
            "friends": len(user_info.get("friends", [])) if isinstance(user_info.get("friends"), list) else user_info.get("friends")
        }

        stats_str = (
            f"Reviews: {stats['review_count']}, "
            f"Votes - useful: {stats['useful']}, funny: {stats['funny']}, cool: {stats['cool']}, "
            f"Elite years: {stats['elite']}, "
            f"Number of friends: {stats['friends']}"
        )

        prompt_filled = f"""You are given structured statistics of a user from the {source} dataset:

    {stats_str}

    Write a short, fluent second-person description (around 80-120 words) that:
    1. Explains how active you are (reviews, votes).
    2. Mentions whether you look like an influential user (based on votes & elite years).
    3. Mentions roughly how social you are (friends).
    4. Avoids listing numbers mechanically; convert them to natural language.
    5. Stays neutral and fair.

    Return only the description, no bullet points, no quoting the raw stats.
    """
        return self.reasoning(prompt_filled)
```

还在最终生成结果模块（workflow）引入 **Few-shot Learning** （少样本学习），在生成评论的提示词中加入用户过去的几条真实评论作为示例。这能让模型更直观地模仿用户的评分标准（是偏宽容还是偏严厉）和语言风格（如口头禅、句式长度）。

```
        You are a real human user on {source} dataset.
        
        ### User Profile
        - **Description**: {after_user_info}
        - **Review Style**: {user_reviews_text}
        - **Historical Average Rating**: {user_avg_stars} (This indicates your baseline satisfaction level)

        ### Your Past Review Examples
        To help you stay in character, here are a few reviews you have written in the past:
        {examples_str}

        ### Business Profile
        - **Description**: {item_description}
        - **Public Rating**: {item_avg_stars} (This indicates the general quality of the business)
        - **Community Feedback**: {item_reviews_text}
        
        ### Scenario
        Imagine you have just visited this business. You need to write a review based on your personal experience, which should be consistent with your user profile and the business's actual quality.

        ### Instructions & Constraints
        1. **Rating**: Decide your rating (1.0-5.0). Carefully balance your personal standards (User Avg) with the business's quality (Item Avg). Refer to your past examples to calibrate your rating scale.
        2. **Emotion & Tone**: Adopt the persona defined in "Review Style" and your past examples. Mimic your own writing style.
        3. **Content**: Write 2-4 sentences. Focus on specific details (food, service, etc.) mentioned in the business description or feedback.
        4. **Format**:
            stars: [your rating]
            review: [your review]
```

**github提交**：https://github.com/DawnSaint/CS6535-Guided-Study-in-Artificial-Intelligence/commit/c470afd6d80d83d0be7d7c4d8f5b1a5ea0470bb2



##### IV、添加类别检测系统辅助生成

我们分析数据的时候还发现，yelp的数据集中，item的类别可能有 Restaurants, Dentists, Bars, Beauty Salons, Doctors 等多种类别，用户对不同类别商家的侧重点也不同，使用同一个prompt生成回复难以全面覆盖，因此我们使用大模型帮助分析数据，提取出 6 个主要的商家类型，做出以下改进以保证最终结果的生成质量。

1. **添加了类别检测系统** - detect_item_category() 方法，根据商家的 categories 和 name 字段自动识别商家类型
2. **定义了6大类别的关键评价维度**，易于扩展新类别（只需在category_dimensions中添加）：
   - 餐饮类：关注食物质量、口味、份量、服务速度等
   - 购物类：关注商品种类、质量、价格、店员服务等
   - 服务类：关注服务质量、专业度、清洁度等
   - 旅游类：关注位置、房间状况、设施、性价比等
   - 医疗类：关注专业水平、等待时间、清洁度等
   - 其他类别：通用评价维度
3. **改进了 generate_item_review_description() 方法**:
   - 根据类别提取对应的关键评价维度
   - 在prompt中明确要求关注该类别特定的 focus_areas
   - 生成更具针对性的评论总结



**github提交**：https://github.com/DawnSaint/CS6535-Guided-Study-in-Artificial-Intelligence/commit/fc3a95970a09e71fb163db2354d3f9cf13e5ac8c





##### V. 引入投票机制（Self-Consistency）

更新 ReasoningBaseline，使其接受一个 temperature 参数，以便在生成过程中产生多样化的输出。
更新 MySimulationAgent.workflow，使其生成多个评论候选（进行投票），而非仅生成一个，然后计算这些候选评论的平均评分，并选择最接近该平均值的评论，从而确保输出更加稳定且具有代表性。

**github提交**：https://github.com/DawnSaint/CS6535-Guided-Study-in-Artificial-Intelligence/commit/c756b3362b2806de79e411f35acf84267e3ddffe





##### 最终结果

最近的 100 次结果如下：

|                    | preference_estimation | review_generation  | overall_quality    |
| ------------------ | --------------------- | ------------------ | ------------------ |
| evaluated_count_25 | 0.892                 | 0.8810979843635185 | 0.8865489921817593 |
| evaluated_count_25 | 0.872                 | 0.8819439050097853 | 0.8769719525048927 |
| evaluated_count_20 | 0.915                 | 0.8413377248192566 | 0.8781688624096283 |
| evaluated_count_20 | 0.9                   | 0.8462833806169042 | 0.8731416903084521 |
| evaluated_count_10 | 0.9                   | 0.864636797995193  | 0.8823183989975965 |

